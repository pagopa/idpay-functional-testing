trigger:
  - main

variables:
  # Python version: 3.x
  pythonVersion: '3.x'
  # Folder name of this sub-repository
  working-dir: '.'
  # Project root folder
  projectRoot: $(System.DefaultWorkingDirectory)/$(working-dir)
  selfHostedAgentPool: 'cstar-uat-linux'
  TIME_OUT: 10

pool:
  vmImage: 'ubuntu-22.04'

parameters:
  - name: env
    displayName: Target Environment
    type: string
    default: uat
    values:
      - uat

  - name: tag
    displayName: Target tests tag
    type: string
    default: ''

stages:
  - stage: Functional_tests
    dependsOn: [ ]
    pool:
      name: $(selfHostedAgentPool)
    jobs:
      - job: "run_functional_tests"
        steps:
          - checkout: self
          - script: |
              python3 --version
              pip3 --version
            displayName: "Display Python version"
          - script: |
              python3 --version
              python3 -m pip install --user virtualenv
              python3 -m virtualenv .venv
              source .venv/bin/activate
              pip install -r requirements.txt
            displayName: "Install requirements"
          - task: DownloadSecureFile@1
            name: idpay_secrets
            displayName: 'Download IDPay secrets'
            inputs:
              secureFile: '.secrets.yaml'
          - script: |
              source .venv/bin/activate
              if [ -z "${{ parameters.tag }}" ]; then
                pytest --junitxml=tests/reports/pytest/junit.xml -vv --collect-only
              else
                pytest --junitxml=tests/reports/pytest/junit.xml -vv -m "${{ parameters.tag }}"" --collect-only
              fi
              displayName: 'Run tests with Pytest'
            env:
              IDPAY_SECRET_PATH: $(idpay_secrets.secureFilePath)
              IDPAY_TARGET_ENV: ${{ parameters.env }}
            continueOnError: true
          - task: PublishTestResults@2
            continueOnError: true
            #            condition: true
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'tests/reports/pytest/junit.xml'
              testRunTitle: 'Pytest Results'
              searchFolder: $(Build.SourcesDirectory)
              failTaskOnFailedTests: true
          - script: |
              source .venv/bin/activate
              if [ -z "${{ parameters.tag }}" ]; then
                behave --junit --junit-directory "tests/reports/behave" --tags ~@skip -d
              else
                behave --junit --junit-directory "tests/reports/behave" --tags "@${{ parameters.tag }} -d"
              fi
            displayName: 'Run tests with Behave'
            env:
              IDPAY_SECRET_PATH: $(idpay_secrets.secureFilePath)
              IDPAY_TARGET_ENV: ${{ parameters.env }}
            continueOnError: true
          - task: PublishTestResults@2
            #            condition: true
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'tests/reports/behave/*.xml'
              testRunTitle: 'Behave Results'
              searchFolder: $(Build.SourcesDirectory)
              failTaskOnFailedTests: true
            continueOnError: true
